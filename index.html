from flask import Flask, jsonify, render_template_string, send_file
import random, time
from io import BytesIO

app = Flask(__name__)

# HTML template: same UI as you provided, but BACKEND_URL points to /api/metrics
TEMPLATE = r"""<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sasha Innoworks — Live Dashboard (Flask)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#061026; --panel:#0e2033; --muted:#9fc0d9; --text:#eaf7ff;
  --sub:#cfeaf9; --accent:#2fb8ff; --accent-2:#6ecbff; --amber:#f1a63c;
  --radius:14px;
}
*{box-sizing:border-box}
body{margin:0;min-height:100vh;background:linear-gradient(180deg,#031021 0%,var(--bg) 100%);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
.wrap{max-width:1180px;margin:18px auto;padding:16px;display:grid;gap:14px}
header.top{display:flex;align-items:center;gap:14px;padding:12px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.006));border:1px solid rgba(47,184,255,0.06)}
.logo{width:60px;height:60px;border-radius:10px;background:linear-gradient(90deg,var(--amber),#d68a2a);display:flex;align-items:center;justify-content:center;font-weight:800;color:#081214}
.title{font-size:28px;font-weight:800;margin:0}
.company{font-size:12px;color:var(--sub);margin-top:4px}
.layout{display:grid;grid-template-columns:1fr 380px;gap:16px;margin-top:8px}
.panel{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.006));padding:12px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.02)}
.feed-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.feed-area{height:360px;border-radius:12px;border:2px solid rgba(255,255,255,0.03);position:relative;display:flex;align-items:center;justify-content:center;overflow:hidden}
.camera{position:absolute;right:16px;top:12px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.03);color:var(--sub);font-weight:700}
.track{position:absolute;left:18px;right:18px;bottom:30px;height:60px;border-radius:999px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));display:flex;align-items:center;justify-content:space-around;padding:8px 24px;border:1px solid rgba(255,255,255,0.02)}
.wheel{width:26px;height:26px;border-radius:50%;background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(255,255,255,0.02))}
.bottle-strip{display:flex;gap:44px;align-items:flex-end;will-change:transform}
.bottle-box{width:72px;height:160px;display:flex;align-items:flex-end;justify-content:center}
.small{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px 10px;border-radius:10px;color:var(--sub);cursor:pointer}
.controls{display:flex;align-items:center;justify-content:space-between;margin-top:12px}
.flow{display:flex;gap:10px;align-items:center;color:var(--sub);font-weight:700}
.dot{width:12px;height:12px;border-radius:50%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.03);cursor:pointer}
.dot.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));box-shadow:0 8px 22px rgba(47,184,255,0.08)}
.metrics{display:flex;flex-direction:column;gap:12px}
.metric-card{padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02)}
.metric-title{font-weight:800;color:var(--sub);margin-bottom:6px}
.big-val{font-size:26px;font-weight:800}
.progress{height:12px;border-radius:999px;background:rgba(255,255,255,0.03);overflow:hidden}
.progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width 600ms ease}
.events{max-height:170px;overflow:auto;margin-top:8px}
.events li{padding:8px 6px;border-bottom:1px solid rgba(255,255,255,0.02);color:var(--sub)}
.bottom{margin-top:12px;display:grid;grid-template-columns:1fr 420px;gap:16px}
table{width:100%;border-collapse:collapse}
thead th{color:var(--sub);font-weight:800;text-align:left;padding:10px;border-bottom:1px solid rgba(255,255,255,0.03)}
tbody td{padding:12px 8px;border-bottom:1px solid rgba(255,255,255,0.02);color:var(--text)}
.graph-panel{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02)}
.canvas{width:100%;height:180px;display:block}
.bottle-selected{outline:3px solid rgba(47,184,255,0.12);border-radius:12px;padding:4px}
@media (max-width:980px){.layout{grid-template-columns:1fr}.bottom{grid-template-columns:1fr}.metrics{order:2}}
/* small helper: amber fill variable for easy change */
.liquid-amber { fill: var(--amber); opacity: 0.95; }
.liquid-cyan { fill: var(--accent); opacity: 0.95; }
</style>
</head>
<body>
<div class="wrap">
  <header class="top">
    <img id="logoImg" src="/logo.png" alt="logo" onerror="applyPlaceholderLogo()" style="width:60px;height:60px;border-radius:10px;object-fit:cover;border:3px solid rgba(0,0,0,0.06)">
    <div>
      <div class="title">Dashboard</div>
      <div class="company">Sasha Innoworks</div>
    </div>
    <div style="margin-left:auto;display:flex;gap:12px;align-items:center">
      <div style="color:var(--sub);font-weight:700">Operator: <span style="color:var(--text)">Operator 1</span></div>
      <button class="small">Profile</button>
    </div>
  </header>

  <div class="layout">
    <!-- left -->
    <section class="panel">
      <div class="feed-top">
        <div style="font-weight:800;font-size:18px">Conveyor Feed</div>
        <div style="color:var(--sub)">Status: <strong id="statusText" style="color:var(--accent)">Running</strong></div>
      </div>

      <div class="feed-area" id="feedArea">
        <div class="camera">CAM</div>
        <div style="width:92%;max-width:880px;position:relative">
          <div class="bottle-strip" id="bottleStrip" aria-hidden="true">
            <!-- SVG bottles will be generated by JS -->
          </div>

          <div class="track" aria-hidden="true">
            <div class="wheel"></div><div class="wheel"></div><div class="wheel"></div><div class="wheel"></div>
          </div>
        </div>
      </div>

      <div class="controls">
        <div class="flow">
          <div style="font-weight:800">Flow Speed</div>
          <div style="display:flex;gap:8px;margin-left:8px">
            <div class="dot" data-speed="1"></div>
            <div class="dot active" data-speed="2"></div>
            <div class="dot" data-speed="3"></div>
            <div class="dot" data-speed="4"></div>
          </div>
        </div>
        <div class="actions">
          <button class="small" id="pauseBtn">Pause</button>
          <button class="small" id="resumeBtn">Resume</button>
          <button class="small" id="stopBtn">Stop</button>
        </div>
      </div>
    </section>

    <!-- right -->
    <aside class="metrics">
      <div class="metric-card">
        <div class="metric-title">Liquid Level (selected)</div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="big-val" id="selVal">—%</div>
          <div style="font-size:12px;color:var(--sub)" id="selLabel">Bottle —</div>
        </div>
        <div style="height:10px;margin-top:8px" class="progress"><i id="selBar" style="width:0%"></i></div>
      </div>

      <div class="metric-card">
        <div class="metric-title">Text Detection</div>
        <div style="margin-top:6px;color:var(--text);font-weight:700" id="detectedLabel">BEVARAGE</div>
        <div style="color:var(--sub);margin-top:6px">MFG: <span id="mfg">2024-04-24</span> • Exp: <span id="exp">2025-04-24</span></div>
      </div>

      <div class="metric-card">
        <div class="metric-title">Event Log</div>
        <ul class="events" id="events">
          <li>10 — Underfill bottle detected</li>
          <li>142 — Label: BEVERAGE</li>
          <li>23 — Conveyor resumed</li>
        </ul>
      </div>

      <div class="metric-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="metric-title">Real-time Liquid Graph</div><div style="color:var(--sub);font-size:12px">Last 60</div>
        </div>
        <div style="margin-top:8px">
          <canvas id="liveGraph" class="canvas"></canvas>
        </div>
      </div>
    </aside>
  </div>

  <div class="bottom">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:800">Production Summary</div>
        <div style="color:var(--sub);font-size:13px">Recent</div>
      </div>
      <table>
        <thead><tr><th>Time</th><th>Status</th><th>Fill %</th><th>Label</th><th>Dimensions</th></tr></thead>
        <tbody id="summaryTable">
        </tbody>
      </table>
    </div>

    <div class="graph-panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:800">Overall Liquid Trend</div><div style="color:var(--sub);font-size:12px">Combined</div>
      </div>
      <canvas id="overallGraph" class="canvas"></canvas>
    </div>
  </div>
</div>

<script>
const BACKEND_URL = "/api/metrics"; // use our Flask backend

function applyPlaceholderLogo(){
  const img = document.getElementById('logoImg');
  img.src = '';
  img.style.background = "linear-gradient(90deg,var(--amber), #d68a2a)";
  img.style.display = "inline-block";
  img.alt = "Sasha Innoworks";
  img.style.border = "3px solid rgba(0,0,0,0.06)";
  img.style.objectFit = "cover";
}

/* UI refs */
const bottleStrip = document.getElementById('bottleStrip');
const dots = document.querySelectorAll('.dot');
const pauseBtn = document.getElementById('pauseBtn');
const resumeBtn = document.getElementById('resumeBtn');
const stopBtn = document.getElementById('stopBtn');
const selVal = document.getElementById('selVal');
const selBar = document.getElementById('selBar');
const selLabel = document.getElementById('selLabel');
const liveCanvas = document.getElementById('liveGraph');
const overallCanvas = document.getElementById('overallGraph');
const eventsEl = document.getElementById('events');
const summaryTable = document.getElementById('summaryTable');

let paused = false;
let speed = 0.8;
let offset = 0;
let bottles = [];
let NUM_BOTTLES = 4;
let selected = 0;

// create bottle SVGs placeholder; they will be updated by /api/metrics data
function createBottleSVGs(){
  bottleStrip.innerHTML = '';
  for(let i=0;i<NUM_BOTTLES*3;i++){
    const bid = i % NUM_BOTTLES;
    const div = document.createElement('div'); div.className='bottle-box';
    const svg = ` <svg class="bottle-svg" data-bid="${bid}" viewBox="0 0 72 160" width="72" height="160">\n              <path d="M26 0h20a6 6 0 0 1 6 6v16a10 10 0 0 1 10 10v110a12 12 0 0 1-12 12H22a12 12 0 0 1-12-12V32a10 10 0 0 1 10-10V6a6 6 0 0 1 6-6z" fill="none" stroke="#eaf7ff" stroke-width="3"/>\n              <rect class="liquid-rect liquid-amber" x="16" y="72" rx="8" width="40" height="68"></rect>\n            </svg>`;
    div.innerHTML = svg; bottleStrip.appendChild(div);
  }
}
createBottleSVGs();

function selectBottle(bid){
  selected = bid;
  selLabel.textContent = 'Bottle ' + (bid+1);
  document.querySelectorAll('.bottle-box').forEach((box, idx)=>{
    box.classList.toggle('bottle-selected', (idx % NUM_BOTTLES) === bid);
  });
}

function updateSelectedUI(){
  const b = bottles[selected] || {level:0, history:[]};
  selVal.textContent = b.level + '%';
  selBar.style.width = b.level + '%';
  drawAll();
}

/* animate strip */
function animateStrip(){
  if(!paused){
    offset -= speed; const w = bottleStrip.scrollWidth;
    if(Math.abs(offset) > w/2) offset = 0;
    bottleStrip.style.transform = `translateX(${offset}px)`;
  }
  requestAnimationFrame(animateStrip);
}
animateStrip();

/* dots */
dots.forEach((d, idx) => { d.addEventListener('click', ()=>{ dots.forEach(x=>x.classList.remove('active')); d.classList.add('active'); speed = 0.5 + idx*0.8; }); });
pauseBtn.addEventListener('click', ()=> paused = true);
resumeBtn.addEventListener('click', ()=> paused = false);
stopBtn.addEventListener('click', ()=> { paused = true; offset = 0; });

/* canvas helpers */
function fitCanvas(canvas){
  const rect = canvas.getBoundingClientRect();
  const ratio = window.devicePixelRatio || 1;
  canvas.width = Math.floor(rect.width * ratio);
  canvas.height = Math.floor(rect.height * ratio);
  const ctx = canvas.getContext('2d');
  ctx.setTransform(ratio,0,0,ratio,0,0);
  return ctx;
}
const liveCtx = fitCanvas(liveCanvas);
const overallCtx = fitCanvas(overallCanvas);
window.addEventListener('resize', ()=> { fitCanvas(liveCanvas); fitCanvas(overallCanvas); drawAll(); });

function drawLive(){
  const ctx = liveCtx; const cw = liveCanvas.clientWidth; const ch = liveCanvas.clientHeight;
  ctx.clearRect(0,0,cw,ch); ctx.fillStyle = 'rgba(255,255,255,0.01)'; ctx.fillRect(0,0,cw,ch);
  const arr = (bottles[selected] && bottles[selected].history) ? bottles[selected].history.slice(-60) : [];
  if(arr.length < 2) return; const margin = 8; const plotW = cw - margin*2; const plotH = ch - margin*2; const step = plotW / (Math.max(arr.length-1,1));
  const g = ctx.createLinearGradient(0,0,0,ch); g.addColorStop(0,'rgba(241,166,60,0.16)'); g.addColorStop(1,'rgba(241,166,60,0.02)');
  ctx.beginPath(); for(let i=0;i<arr.length;i++){ const x = margin + i*step; const y = margin + (1 - arr[i]/100) * plotH; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }
  ctx.lineTo(margin + (arr.length-1)*step, margin+plotH); ctx.lineTo(margin, margin+plotH); ctx.closePath(); ctx.fillStyle = g; ctx.fill();
  ctx.beginPath(); for(let i=0;i<arr.length;i++){ const x=margin+i*step; const y=margin+(1-arr[i]/100)*plotH; if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);} ctx.strokeStyle = 'rgba(241,166,60,0.95)'; ctx.lineWidth = 2.2; ctx.stroke();
  const lastX = margin + (arr.length-1)*step; const lastY = margin + (1-arr[arr.length-1]/100)*plotH; ctx.beginPath(); ctx.fillStyle='rgba(255,255,255,0.95)'; ctx.arc(lastX,lastY,3,0,Math.PI*2); ctx.fill();
}

function drawOverall(){
  const ctx = overallCtx; const cw = overallCanvas.clientWidth; const ch = overallCanvas.clientHeight; ctx.clearRect(0,0,cw,ch); ctx.fillStyle = 'rgba(255,255,255,0.01)'; ctx.fillRect(0,0,cw,ch);
  const len = Math.max(...(bottles.map(b=>b.history.length)) || [0]); const arr = [];
  for(let i=0;i<len;i++){
    let sum=0,count=0; bottles.forEach(b=>{ const v = b.history[b.history.length - len + i]; if(typeof v==='number'){ sum+=v; count++; }});
    if(count) arr.push(Math.round(sum/count));
  }
  if(arr.length < 2) return; const margin = 10; const plotW = cw - margin*2; const plotH = ch - margin*2; const step = plotW / (Math.max(arr.length-1,1));
  const g = ctx.createLinearGradient(0,0,0,ch); g.addColorStop(0,'rgba(47,184,255,0.12)'); g.addColorStop(1,'rgba(47,184,255,0.02)');
  ctx.beginPath(); for(let i=0;i<arr.length;i++){ const x=margin+i*step; const y=margin+(1-arr[i]/100)*plotH; if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);} ctx.lineTo(margin+(arr.length-1)*step, margin+plotH); ctx.lineTo(margin,margin+plotH); ctx.closePath(); ctx.fillStyle=g; ctx.fill();
  ctx.beginPath(); for(let i=0;i<arr.length;i++){ const x=margin+i*step; const y=margin+(1-arr[i]/100)*plotH; if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);} ctx.strokeStyle='rgba(47,184,255,0.98)'; ctx.lineWidth=2.2; ctx.stroke();
}

function drawAll(){ drawLive(); drawOverall(); }

function refreshBottleSVGs(){
  for(let b of bottles){
    const maxH = 96; const h = Math.round(maxH * (b.level / 100)); const y = 160 - 12 - h;
    document.querySelectorAll(`.bottle-svg[data-bid="${b.id}"]`).forEach(svg=>{ const rect = svg.querySelector('.liquid-rect'); if(rect){ rect.setAttribute('height', h); rect.setAttribute('y', y); } });
  }
}

/* fetch data from backend and update UI */
async function fetchAndUpdateLive(){
  try{
    const res = await fetch(BACKEND_URL);
    if(!res.ok) throw new Error('bad response');
    const data = await res.json();
    bottles = data.bottles.map(b=>({id:b.id, level:b.level, history:b.history||[b.level]}));
    // events
    if(Array.isArray(data.events)){
      eventsEl.innerHTML=''; data.events.slice(0,12).forEach(e=>{ const li=document.createElement('li'); li.textContent = `${e.time || ''}  ${e.text || ''}`; eventsEl.appendChild(li); });
    }
    // summary
    if(Array.isArray(data.production_summary)){
      summaryTable.innerHTML=''; data.production_summary.slice(0,10).forEach(row=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${row.time}</td><td style="color:${row.status==='OK'?'#6be58b':'#ff6b6b'}">${row.status}</td><td>${row.fill}%</td><td>${row.label}</td><td>${row.dimensions}</td>`; summaryTable.appendChild(tr); });
    }
    refreshBottleSVGs(); updateSelectedUI(); drawAll();
  }catch(err){ console.warn('fetch failed', err); }
}

setInterval(fetchAndUpdateLive, 1800);
fetchAndUpdateLive();
selectBottle(0);

</script>
</body>
</html>
"""

# ---------------- Backend simulation state ----------------
NUM_BOTTLES = 4
bottles = []
for i in range(NUM_BOTTLES):
    lvl = random.randint(40, 90)
    history = [max(6, min(98, lvl + random.randint(-5,5))) for _ in range(30)]
    bottles.append({"id": i, "level": lvl, "history": history})

# simple events and summary generators

@app.route('/')
def index():
    return render_template_string(TEMPLATE)

@app.route('/api/metrics')
def api_metrics():
    global bottles
    # update bottles slightly
    for idx, b in enumerate(bottles):
        change = int((random.random() - 0.5) * 6 + (time.time() / 7.0) % 3 - 1)
        b['level'] = max(6, min(98, b['level'] + change))
        b.setdefault('history', []).append(b['level'])
        if len(b['history']) > 60:
            b['history'] = b['history'][-60:]

    # create events (mock)
    events = []
    if random.random() < 0.25:
        events.append({"time": time.strftime('%H:%M:%S'), "text": "Underfill bottle detected"})
    if random.random() < 0.15:
        events.append({"time": time.strftime('%H:%M:%S'), "text": "Label not identified"})

    # production summary
    summary = []
    for _ in range(4):
        s = random.choice(["OK","Underfilled"]) if random.random() < 0.4 else "OK"
        summary.append({"time": time.strftime('%H:%M:%S'), "status": s, "fill": random.randint(50, 99), "label": random.choice(["Identified","Not Identified"]), "dimensions": f"{random.randint(8,12)}x{random.randint(10,14)}"})

    return jsonify({"bottles": bottles, "events": events, "production_summary": summary})

@app.route('/logo.png')
def logo():
    # return a tiny transparent PNG as placeholder
    img_bytes = BytesIO()
    # a 1x1 transparent PNG file (hard-coded bytes)
    img_bytes.write(b'\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x01\x00\x00\x00\x01\x08\x06\x00\x00\x00\x1f\x15\xc4\x89\x00\x00\x00\x0cIDATx\x9cc```\x00\x00\x00\x02\x00\x01\xe2!\xbc\x33\x00\x00\x00\x00IEND\xaeB`\x82')
    img_bytes.seek(0)
    return send_file(img_bytes, mimetype='image/png')

if __name__ == '__main__':
    app.run(debug=True, port=5000)
